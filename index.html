<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <style>
    html,
    body,
    #divMapView {
        padding: 0;
        margin: 0;
        width:100%;
        height:100%;
    }
    #divToolbar {
        top:0;
        width:100%;
        position: fixed;
        background:rgba(0,0,0,0.6);
        color: white;
    }
    .searchBox {
        width:200px;
        right:0;
        position: absolute;
        background-color: rgba(255,255,255);
        color: black;
    }
    .searchResult {
        display:none;
        width:200px;
        height:60px;
        right:0;
        position: absolute;
        background-color: rgba(255,255,255);
        color: black;
    }

    </style>
    <title>San Diego Landmark Locator</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.9/esri/css/main.css">
    <script src="https://js.arcgis.com/4.9/"></script> 
    <script>
     let divSearchResults;
 
     function onSearch (e) {
        if (e.code != "Enter") return;
        
        divSearchResults.style.display = "block";
        const q = e.target.value;
        const landmarkLayer = getActiveLayer();
        const query = landmarkLayer.createQuery();
        query.where = "Name like '%" + q + "%'";
        query.returnGeometry=false;
        query.num = 3;
        divSearchResults.innerHTML = "";
        landmarkLayer.queryFeatures(query)

        .then(result => result.features.forEach(f => {
            let r = document.createElement("li")
            r.textContent = f.attributes.Name;
            divSearchResults.appendChild(r);
        }))
        .catch(e => alert ("Error executing query " + e));
     }

     function onTypeChange(e) {
        const dd = e.target;
        const selectedIndex = dd.options.selectedIndex;
        const type = dd.options[selectedIndex].textContent;
        const landmarkLayer = getActiveLayer(); 
        const query = landmarkLayer.createQuery();
        if (type == "All")
            query.where = "1=1";
        else
            query.where = "Type = '" + type + "'";
        
        landmarkLayer.definitionExpression = query.where;
        landmarkLayer.queryFeatureCount(query)
        .then(c => {
            const lblTypeCount = document.getElementById("lblTypeCount");
            lblTypeCount.textContent = c;
        })
        .catch(e => alert("Error executing function."))
     }

     function loadLandmarkTypes() {
        const ddTypeList = document.getElementById("ddTypeList");
        const landmarkLayer = getActiveLayer();
        const query = landmarkLayer.createQuery();
        query.outFields = ["type"];
        query.returnGeometry = false;
        query.returnDistinctValues = true;
        const oAll = document.createElement("option");
        oAll.textContent = "All";
        ddTypeList.appendChild(oAll);
        landmarkLayer.queryFeatures(query)
        .then(result =>  result.features.forEach(t => {
            let o = document.createElement("option");
            o.textContent = t.attributes.Type;
            ddTypeList.appendChild(o)
        }))
        .catch(e => alert("Error executing query." + e));
         
     }

     function loadLayers(layers) {
      const ddLayerList = document.getElementById("ddLayerList");
       layers.forEach(l => {
            let o = document.createElement("option");
            o.textContent = l.title;
            o.layer = l;
            ddLayerList.appendChild(o)
       });
     }

     function getActiveLayer () {
        const ddLayerList = document.getElementById("ddLayerList");
        const selectedIndex = ddLayerList.options.selectedIndex;
        return ddLayerList.options[selectedIndex].layer;
     }
      
     require (["esri/WebMap", "esri/views/MapView"],
     (WebMap,MapView) => {
        const map = new WebMap({
            "portalItem" : {
                "id" : "2e4db9b83977465b878fbafc4dc96a1d"
            }
        });
        const mapView = new MapView({ 
            "container" : "divMapView",
            "map" : map
        })
        
        map.when(() => {
            //map is ready
            loadLayers(map.layers);
            loadLandmarkTypes();
            
            //setup events 
            const ddTypeList = document.getElementById("ddTypeList");
            const txtSearch = document.getElementById("txtSearch");
            divSearchResults = document.getElementById("divSearchResults");
            ddTypeList.addEventListener("change", onTypeChange);
            txtSearch.addEventListener("keypress", onSearch);
            //divSearchResults.addEventListener("focusout", e => e.target.style.display="none")
        })
          

     })  
    </script>
</head>
<body>
    <div id = 'divMapView'></div>
    <div id = 'divToolbar'>
        <label>Layers</label>
        <select id = 'ddLayerList'>
        </select>
        <label>Types</label>
        <select id = 'ddTypeList'>
        </select>
        <label id = 'lblTypeCount'></label>
        <input type = 'text' id = 'txtSearch' class = 'searchBox'>
        <div id = 'divSearchResults' class = 'searchResult'>
             search result 1
             search result 2
             search result 3
        </div>
    </div>
</body>
</html>